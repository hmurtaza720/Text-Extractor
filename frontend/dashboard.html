<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TextExtract</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary-green': '#4A997A'
                    },
                    animation: {
                        blob: "float 20s ease-in-out infinite both alternate",
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'none' },
                            '50%': { transform: 'translate(50%, 20%) rotateY(10deg) scale(1.2)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .animation-delay-2000 {
            animation-delay: 2s;
        }

        .animation-delay-4000 {
            animation-delay: 4s;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Smooth scrolling for mobile */
        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .glass-sidebar {
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-header {
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="bg-gray-200 h-screen flex overflow-hidden relative">

    <!-- Animated Background Globs (Copied from Login) -->
    <div
        class="absolute top-20 left-2 w-[500px] h-[500px] bg-[#B3C9C2] rounded-full mix-blend-multiply filter blur-[150px] opacity-50 animate-blob pointer-events-none">
    </div>
    <div
        class="absolute top-20 right-32 w-[500px] h-[500px] bg-[#A3BFC9] rounded-full mix-blend-multiply filter blur-[150px] opacity-50 animate-blob animation-delay-2000 pointer-events-none">
    </div>
    <div
        class="hidden xl:block absolute bottom-10 left-32 w-[500px] h-[500px] bg-[#809090] rounded-full mix-blend-multiply filter blur-[150px] opacity-50 animate-blob animation-delay-4000 pointer-events-none">
    </div>
    <div
        class="absolute bottom-10 right-52 w-[500px] h-[500px] bg-[#A3BFC9] rounded-full mix-blend-multiply filter blur-[150px] opacity-50 animate-blob animation-delay-4000 pointer-events-none">
    </div>

    <!-- Sidebar (Translucent) -->
    <!-- Modern Floating Sidebar -->
    <aside class="hidden md:flex flex-col w-72 z-20 p-4">
        <div class="h-full flex flex-col glass-panel rounded-2xl shadow-2xl">
            <!-- Brand -->
            <div class="h-20 flex items-center px-8 border-b border-white/10">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-primary-green to-teal-400 rounded-lg shadow flex items-center justify-center text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-800 tracking-tight">TextExtract</span>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#"
                    class="flex items-center px-4 py-3 text-gray-800 bg-white/50 backdrop-blur-sm rounded-xl transition-all shadow-sm border border-white/40 group">
                    <svg class="w-5 h-5 mr-3 text-primary-green transition-transform group-hover:scale-110" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                        </path>
                    </svg>
                    <span class="font-semibold">Documents</span>
                </a>
                <a href="/settings"
                    class="flex items-center px-4 py-3 text-gray-600 hover:bg-white/30 hover:text-gray-800 rounded-xl transition-all border border-transparent hover:border-white/20 group">
                    <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-primary-green transition-colors" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>

            <!-- Profile Info -->
            <div class="px-4 pb-4">
                <div class="glass-panel p-4 rounded-xl border border-white/30 bg-white/20">
                    <div class="flex items-center space-x-3 mb-3">
                        <img id="sidebar-profile-img" src="https://ui-avatars.com/api/?name=User&background=random"
                            alt="Profile" class="w-10 h-10 rounded-full shadow-md border-2 border-white/50" />
                        <div>
                            <div class="text-xs text-gray-500 font-semibold uppercase tracking-wider">Welcome</div>
                            <div id="sidebar-user-name" class="text-sm font-bold text-gray-800 truncate max-w-[120px]">
                                Loading...</div>
                        </div>
                    </div>
                    <button onclick="handleLogout()"
                        class="w-full py-2 text-xs font-bold text-white bg-red-400/80 hover:bg-red-500/90 rounded-lg shadow-sm transition-all flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative z-10">

        <!-- Top Header (Translucent) -->
        <!-- Search & Filter Section -->
        <div
            class="h-16 md:h-24 flex items-center justify-center px-4 sm:px-6 lg:px-8 z-20 relative transition-all duration-300">
            <!-- Mobile Toggle -->
            <div class="absolute left-4 md:hidden z-30">
                <button onclick="toggleMobileMenu()"
                    class="text-gray-600 hover:text-gray-800 p-2 glass-panel rounded-lg active:scale-95 transition-transform">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
            <div class="flex items-center w-full max-w-3xl space-x-4 pl-12 md:pl-0">
                <div class="flex-1">
                    <input type="text" placeholder="Search documents or tags..." id="search-input"
                        onkeyup="filterDocuments(this.value)"
                        class="w-full px-4 md:px-6 py-2 md:py-3 rounded-full bg-white/40 backdrop-blur-md border border-white/30 focus:outline-none focus:ring-2 focus:ring-primary-green shadow-sm text-gray-800 placeholder-gray-500 transition text-base md:text-lg" />
                </div>
                <button
                    class="p-3 rounded-full bg-white/40 hover:bg-white/60 backdrop-blur-md border border-white/30 text-gray-600 hover:text-primary-green transition shadow-sm cursor-not-allowed opacity-80"
                    title="Filter (Coming Soon)">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-3 sm:p-6 lg:p-8 smooth-scroll">

            <div class="flex justify-between items-center mb-4 md:mb-6">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">Your Documents</h1>
                <div class="flex space-x-2">
                    <!-- Mobile Camera Button -->
                    <button onclick="document.getElementById('camera-input').click()"
                        class="md:hidden bg-teal-500 hover:bg-teal-600 text-white px-3 py-2 rounded-lg shadow-lg transition flex items-center backdrop-blur-sm border border-white/20 text-sm active:scale-95 transform">
                        <svg class="w-4 h-4 md:w-5 md:h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Camera
                    </button>
                    <!-- Upload Button -->
                    <button onclick="document.getElementById('upload-modal').classList.remove('hidden')"
                        class="bg-primary-green hover:bg-primary-green/90 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg shadow-lg transition flex items-center backdrop-blur-sm border border-white/20 text-sm md:text-base active:scale-95 transform">
                        <svg class="w-4 h-4 md:w-5 md:h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Upload
                    </button>
                </div>
            </div>

            <!-- Documents List (Translucent Card) -->
            <div class="glass-panel rounded-xl overflow-hidden">
                <ul id="document-list" class="divide-y divide-gray-200/50">
                    <li class="p-4 text-center text-gray-600">Loading documents...</li>
                </ul>
            </div>

        </main>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal"
        class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm overflow-y-auto h-full w-full hidden z-50">
        <div
            class="relative top-20 mx-auto p-5 border border-white/40 w-96 shadow-2xl rounded-xl bg-white/80 backdrop-blur-xl">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-bold text-gray-800">Upload Document</h3>
                <div class="mt-4 px-7 py-3">
                    <input type="file" id="file-upload"
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-green/10 file:text-primary-green hover:file:bg-primary-green/20" />
                </div>
                <div id="upload-status" class="text-sm text-gray-600 mb-2"></div>
                <div class="items-center px-4 py-3">
                    <button id="upload-btn" onclick="uploadFile()"
                        class="px-4 py-2 bg-primary-green text-white text-base font-medium rounded-lg w-full shadow-md hover:bg-primary-green/90 focus:outline-none transition">
                        Upload
                    </button>
                    <button onclick="document.getElementById('upload-modal').classList.add('hidden')"
                        class="mt-2 px-4 py-2 bg-gray-100/50 text-gray-700 text-base font-medium rounded-lg w-full shadow-sm hover:bg-gray-200/50 focus:outline-none transition border border-gray-200">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Camera Input (Global) -->
    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden"
        onchange="handleCameraUpload(this)">

    <!-- Mobile Sidebar Overlay -->
    <div id="mobile-sidebar" class="fixed inset-0 z-50 flex hidden" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity opacity-0" id="mobile-backdrop"
            onclick="toggleMobileMenu()"></div>
        <div class="relative flex-1 flex flex-col max-w-xs w-full bg-white/80 backdrop-blur-xl border-r border-white/40 shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out"
            id="mobile-panel">
            <div class="absolute top-0 right-0 -mr-12 pt-2">
                <button onclick="toggleMobileMenu()"
                    class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                    <span class="sr-only">Close sidebar</span>
                    <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 h-0 pt-5 pb-4 overflow-y-auto">
                <div class="flex-shrink-0 flex items-center px-4 mb-6">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-primary-green to-teal-400 rounded-lg shadow mr-3 flex items-center justify-center text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-800">TextExtract</span>
                </div>
                <nav class="px-2 space-y-2">
                    <a href="#"
                        class="bg-primary-green/10 text-primary-green group flex items-center px-4 py-3 text-base font-medium rounded-xl border border-primary-green/20">
                        <svg class="mr-4 h-6 w-6 text-primary-green" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                            </path>
                        </svg>
                        Documents
                    </a>
                    <a href="/settings"
                        class="text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-4 py-3 text-base font-medium rounded-xl transition-colors">
                        <svg class="mr-4 h-6 w-6 text-gray-400 group-hover:text-gray-500" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Settings
                    </a>
                </nav>
            </div>
            <div class="border-t border-gray-200/50 p-4">
                <button onclick="handleLogout()"
                    class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-red-500 hover:bg-red-600">Sign
                    Out</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "";
        let allDocuments = []; // Store fetched docs for filtering

        // Check Auth
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
        }

        async function fetchDocuments() {
            try {
                const response = await fetch(`${API_URL}/documents`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) handleLogout();

                const docs = await response.json();
                allDocuments = docs; // Update global store
                // Apply current filter if any
                const currentSearch = document.getElementById('search-input').value;
                if (currentSearch) {
                    filterDocuments(currentSearch);
                } else {
                    renderDocuments(docs);
                }
            } catch (error) {
                console.error('Error fetching docs:', error);
            }
        }

        function renderDocuments(docs) {
            const list = document.getElementById('document-list');
            if (docs.length === 0) {
                list.innerHTML = '<li class="p-8 text-center text-gray-600 font-medium">No documents found. Upload one to get started!</li>';
                return;
            }

            // Using white/60 for item bg, hover white/80 for interactivity
            list.innerHTML = docs.map(doc => `
                <li class="px-5 py-4 hover:bg-white/50 transition-all duration-200 flex flex-col sm:flex-row sm:items-center sm:justify-between group border-b border-gray-100/50 last:border-0 gap-4 sm:gap-0 relative">
                    <div class="flex items-start w-full sm:w-auto">
                        <div class="flex-shrink-0 h-12 w-12 rounded-xl bg-gradient-to-br from-white/80 to-white/40 shadow-sm flex items-center justify-center text-gray-500 border border-white/60">
                            <!-- Icon based on extension logic or default -->
                            <svg class="h-6 w-6 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <div class="ml-4 flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <div class="text-base font-semibold text-gray-800 cursor-pointer hover:text-primary-green transition truncate max-w-[180px] sm:max-w-sm" onclick="editFilename(this, ${doc.id})" title="Click to rename">${doc.filename || 'Document #' + doc.id}</div>
                                <span class="px-2 inline-flex text-[10px] leading-4 font-bold uppercase tracking-wider rounded-full ${getStatusColor(doc.status)} shadow-sm border border-white/20">
                                    ${doc.status === 'Ready' ? 'Ready' : doc.status}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5 flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                ${new Date(doc.upload_date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                            </div>
                            
                            <!-- Tags Section (Elegant Pills) -->
                            <div class="flex flex-wrap gap-1.5 mt-2">
                                ${(doc.tags || []).map(tag => `
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-medium bg-indigo-50 text-indigo-700 border border-indigo-100/50 cursor-pointer hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition-colors duration-200" 
                                          title="Click to remove tag" onclick="event.stopPropagation(); removeTag(${doc.id}, ${tag.id})">
                                        #${tag.name}
                                    </span>
                                `).join('')}
                                <button onclick="event.stopPropagation(); addTag(${doc.id})" class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-medium bg-gray-50 text-gray-400 border border-gray-100 hover:bg-gray-100 hover:text-gray-600 hover:border-gray-200 transition-colors duration-200" title="Add Tag">
                                    + Tag
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Area -->
            <div class="flex items-center justify-end w-full sm:w-auto mt-4 sm:mt-0 space-x-3">
                <a href="/editor?id=${doc.id}" class="group flex items-center justify-center w-10 h-10 rounded-full bg-white hover:bg-primary-green text-gray-400 hover:text-white border border-gray-200 hover:border-transparent transition-all shadow-sm" title="View">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                </a>
                <button onclick="deleteDocument(${doc.id})" class="group flex items-center justify-center w-10 h-10 rounded-full bg-white hover:bg-red-500 text-gray-400 hover:text-white border border-gray-200 hover:border-transparent transition-all shadow-sm" title="Delete">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
                </li>
                `).join('');

            // Re-render empty state if search filters everything out
            if (docs.length === 0 && allDocuments.length > 0) {
                list.innerHTML = '<li class="p-8 text-center text-gray-600 font-medium">No documents match your search.</li>';
            }

            // Auto-polling: If any document is processing, fetch again in 3 seconds
            const hasProcessing = docs.some(d => d.status === 'Processing' || d.status === 'Sending to N8N...');
            if (hasProcessing) {
                if (window.pollTimer) clearTimeout(window.pollTimer);
                window.pollTimer = setTimeout(fetchDocuments, 3000);
            }
        }

        function filterDocuments(query) {
            const lowerQuery = query.toLowerCase();
            const filtered = allDocuments.filter(doc => {
                const nameMatch = (doc.filename || "").toLowerCase().includes(lowerQuery);
                const tagMatch = (doc.tags || []).some(tag => tag.name.toLowerCase().includes(lowerQuery));
                // Date match: Convert date to string and check
                const dateStr = new Date(doc.upload_date).toLocaleString().toLowerCase();
                const dateMatch = dateStr.includes(lowerQuery);

                return nameMatch || tagMatch || dateMatch;
            });
            renderDocuments(filtered);
        }

        async function addTag(docId) {
            const tagName = prompt("Enter tag name (e.g., invoice, work):");
            if (!tagName) return;

            try {
                const response = await fetch(`${API_URL}/documents/${docId}/tags/${encodeURIComponent(tagName)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchDocuments();
                } else {
                    alert('Failed to add tag');
                }
            } catch (e) {
                console.error(e);
                alert('Error adding tag');
            }
        }

        async function removeTag(docId, tagId) {
            if (!confirm("Remove this tag?")) return;
            try {
                const response = await fetch(`${API_URL}/documents/${docId}/tags/${tagId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) fetchDocuments();
            } catch (e) { console.error(e); }
        }

        function editFilename(element, docId) {
            const currentName = element.innerText;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'text-sm font-medium text-gray-900 border border-indigo-300 rounded px-2 py-1 focus:outline-none focus:border-indigo-500 bg-white/80';

            // Handle save on blur or enter
            input.onblur = () => saveFilename(element, input, docId, currentName);
            input.onkeydown = (e) => {
                if (e.key === 'Enter') input.blur();
            };

            // Prevent click propagation to avoid weird behaviors
            input.onclick = (e) => e.stopPropagation();

            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
        }

        async function saveFilename(element, input, docId, oldName) {
            const newName = input.value.trim();
            if (!newName || newName === oldName) {
                // Restore old name if empty or unchanged
                element.innerText = oldName;
                return;
            }

            try {
                const response = await fetch(`${API_URL} / documents / ${docId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename: newName })
                });

                if (response.ok) {
                    fetchDocuments(); // Refresh list to show updated state
                } else {
                    alert('Failed to rename');
                    element.innerText = oldName;
                }
            } catch (error) {
                console.error(error);
                alert('Error renaming document');
                element.innerText = oldName;
            }
        }

        async function deleteDocument(id) {
            if (!confirm('Are you sure you want to delete this document?')) return;

            try {
                const response = await fetch(`${API_URL}/documents/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchDocuments();
                } else {
                    alert('Failed to delete document');
                }
            } catch (error) {
                console.error(error);
                alert('Error deleting document');
            }
        }

        function getStatusColor(status) {
            if (status === 'Ready') return 'bg-green-100/80 text-green-800';
            if (status === 'Processing') return 'bg-yellow-100/80 text-yellow-800';
            return 'bg-red-100/80 text-red-800';
        }

        async function performUpload(file, statusElementId = 'upload-status') {
            if (!file) return;

            // If using the main modal status
            const statusDiv = document.getElementById(statusElementId);
            const uploadBtn = document.getElementById('upload-btn'); // Only relevant if modal

            if (statusDiv) {
                statusDiv.textContent = "Uploading & Processing...";
                statusDiv.className = "text-sm text-blue-600 mb-2 font-medium";
            }
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.textContent = "Uploading...";
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL}/upload_and_convert`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    if (statusDiv) {
                        statusDiv.textContent = "Upload successful! Processing...";
                        statusDiv.className = "text-sm text-green-600 mb-2 font-medium";
                    }
                    setTimeout(() => {
                        document.getElementById('upload-modal').classList.add('hidden');
                        fetchDocuments(); // Refresh list
                        if (uploadBtn) {
                            uploadBtn.disabled = false;
                            uploadBtn.textContent = "Upload";
                        }
                        if (statusDiv) statusDiv.textContent = "";
                        // Reset inputs
                        document.getElementById('file-upload').value = "";
                        document.getElementById('camera-input').value = "";
                    }, 500);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error(error);
                if (statusDiv) {
                    statusDiv.textContent = "Error uploading file.";
                    statusDiv.className = "text-sm text-red-600 mb-2 font-medium";
                }
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = "Upload";
                }
                alert("Upload failed. Please try again.");
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            await performUpload(file, 'upload-status');
        }

        async function handleCameraUpload(input) {
            const file = input.files[0];
            if (file) {
                // Show a global loading indicator or reuse the modal?
                // For simplicity, let's open the modal and show status there, or just show a toast.
                // Reusing modal to show progress is easiest for now without new UI
                const modal = document.getElementById('upload-modal');
                modal.classList.remove('hidden');

                // Hide file input in modal since we already have file? 
                // Actually performUpload handles the text update.
                await performUpload(file, 'upload-status');
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const backdrop = document.getElementById('mobile-backdrop');
            const panel = document.getElementById('mobile-panel');

            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('-translate-x-full');
                }, 10);
            } else {
                backdrop.classList.add('opacity-0');
                panel.classList.add('-translate-x-full');
                setTimeout(() => {
                    sidebar.classList.add('hidden');
                }, 300);
            }
        }



        async function fetchUserProfile() {
            try {
                const response = await fetch(`${API_URL} / users / me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('sidebar-user-name').innerText = user.username;
                    // Use UI Avatars for a nice placeholder based on name
                    const encodedName = encodeURIComponent(user.username);
                    document.getElementById('sidebar-profile-img').src = `https://ui-avatars.com/api/?name=${encodedName}&background=random&color=fff`;
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
            }
        }

        // Initialize
        fetchUserProfile();
        fetchDocuments();
        // Simple polling for status updates
        setInterval(fetchDocuments, 10000);

    </script>
</body>

</html>